<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<!-- LOADER -->
	<div id="loader-bg">
		<div id="loader">LOADING</div>
	</div>

	<!-- <img src="../img/spaceoverlay.png" style="position: absolute; z-index: 99999; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none;" /> -->

	<!-- end cover -->
	<div id="cover-flash"></div>

	<!-- DEBUG BOX -->
	<div id="vizbox" style="display: none;">
		<div id="FPSViz">Loading ...</div>
		<div id="DRAWCALLSViz">Loading ...</div>
		<div id="NUMVOXELSViz">Loading ...</div>
		<div id="NUMCOVERBOXESViz">Loading ...</div>
		<div id="XViz">N/A</div>
		<div id="YViz">N/A</div>
		<div id="ZViz">N/A</div>
	</div>

	<!-- PRIMARY UI -->
	<div id="dead-overlay"></div>
	<div id="prevent-overlay"></div>
	<div id="ui-overlay">
		<div id="da-big-text">Left-Click to Start</div>
		<!-- The red part -->
		<div style="display: block">
			<div id="health-uis">
				<svg id="healthbar" class="health" width="200px" height="12px" viewBox="0 0 200 12" version="1.1"
					preserveAspectRatio="none" xmlns:xlink="http://www.w3.org/1999/xlink"
					xmlns="http://www.w3.org/2000/svg">
					<path d="M0 0L200 0L193.436 12L6.83196 12L0 0Z" id="Rectangle" fill="#c72626" fill-rule="evenodd"
						stroke="none">
						<!-- svg animation to pulse the healthbar color and fill and stroke -->
						<animate attributeName="fill" values="#FF0051;#FFFFFF;#FF0051" dur="0.25s" repeatCount="indefinite"
							begin="indefinite" id="health-anim-1" />
						<animate attributeName="stroke" values="none;white;none" dur="0.25s" repeatCount="indefinite"
							begin="indefinite" id="health-anim-2" />
						<animate attributeName="stroke-width" values="0;3;0" dur="0.25s" repeatCount="indefinite"
							begin="indefinite" id="health-anim-3" />
					</path>
				</svg>
	
				<!-- The white part -->
				<svg class="health" width="200px" height="12px" viewBox="0 0 200 12" version="1.1"
					preserveAspectRatio="none" xmlns:xlink="http://www.w3.org/1999/xlink"
					xmlns="http://www.w3.org/2000/svg">
					<path d="M0 0L200 0L193.436 12L6.83196 12L0 0Z" id="Rectangle" fill="#FFFFFF" fill-opacity="0.25"
						fill-rule="evenodd" stroke="none">
					</path>
				</svg>
			</div>

			<div id="npc-chat">
				<div id="npc-text"></div>
				<span id="e">[F]</span>
			</div>
		</div>

		<!-- AMMO COUNTER -->
		<div id="center-ui">
			<div id="ammo-counter">0</div>
			<div id="enemy-counter">0</div>
			<img src="../img/diamond.png" id="middle-crosshair"
				style="position: absolute; margin: auto; left: 0; right: 0; top: 0; bottom: 0; max-width: 32px; z-index: 1000; opacity: 0.25; visibility: hidden;">
		</div>
		
		<!-- RESTART OVERLAY -->
		<div id="restart-helper">Press [R] to Restart</div>

	</div>

	<!-- WEB BROWSER -->
	<div id="popup-window">
		<webview id="fullframe" src="" disablewebsecurity></webview>
	</div>

	<!-- THREE JS IMPORTS -->
	<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
	<script type="importmap">
			{
				"imports": {
					"three": "../opensource/threejs/build/three.module.js",
					"three/addons/": "../opensource/threejs/examples/jsm/",
					"three/nodes": "../opensource/threejs/examples/jsm/nodes/Nodes.js"
				}
			}
	</script>
	<!-- AUDIO ENGINE IMPORT -->
	<script src="../opensource/howler/howler.js"></script>
	<!-- INSPECTOR PANEL IMPORT -->
	<script src="../opensource/dat.gui.min.js"></script>
	<!-- STATS.JS -->
	<!-- <script>(function () { var script = document.createElement('script'); script.onload = function () { var stats = new Stats(); document.body.appendChild(stats.dom); stats.dom.style.zIndex = 1000; requestAnimationFrame(function loop() { stats.update(); requestAnimationFrame(loop) }); }; script.src = 'https://mrdoob.github.io/stats.js/build/stats.min.js'; document.head.appendChild(script); })()</script> -->
	<!-- DOT CROSSHAIR -->

	<div id="end-screen"></div>

	<div id="interaction-text" style="visibility: hidden;"></div>
	<div id="help-text">Loading . . .</div>
</body>

<script type="module">
	// ##########
	// JAVASCRIPT IMPORTS
	// ##########
	// THREE
	import * as THREE from 'three';
	import { mix, range, normalWorld, oscSine, timerLocal } from 'three/nodes';
	// import WebGPU from 'three/addons/capabilities/WebGPU.js';
	// import WebGPURenderer from 'three/addons/renderers/webgpu/WebGPURenderer.js';
	import { PointerLockControls } from './PointerLockControls.js';
	import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
	import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
	import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
	import { SAOPass } from 'three/addons/postprocessing/SAOPass.js';
	import { N8AOPass } from "../opensource/N8AO.js"
	import { OutlinePass } from 'three/addons/postprocessing/OutlinePass.js';
	import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
	import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
	import { ConvexHull } from 'three/addons/math/ConvexHull.js';
	import { LightProbeGenerator } from 'three/addons/lights/LightProbeGenerator.js';
	import { LightProbeHelper } from 'three/addons/helpers/LightProbeHelper.js';
	import { startChatScan, checkChat, incrementChatIndex } from './ChatSystem.js';
	// WRECK
	import { ParticleMesh, Particle } from './ParticleEngine.js'; // particle system
	import { USERSETTINGS, LevelHandler, instancedModelIndex } from './LevelHandler.js'; // user settings and level info
	import { InputHandler } from './InputHandler.js'; // DOM input
	import { lerp, clamp, rapidFloat, moveTowards, createVizSphere } from './EngineMath.js'; // math functions
	import { voxelField, recentlyEditedWorldModels } from './VoxelStructures.js'; // data structures for handling voxels
	import { WeaponHandler } from './WeaponHandler.js'; // Weapon Data
	import { setHelpText, setInteractionText, getInteractionText } from './UIHandler.js'; // User Interface
	import { generateWorld, voxelGeometry, voxelMaterial, globalOffset } from './WorldGenerator.js'; // Map Generation
	import { PlayerController } from './PlayerMotionController.js'; // First Person Controller

	// ##########
	// META
	// ##########
	navigator.mediaSession.setActionHandler('play', function() { /* Code excerpted. */ });
	navigator.mediaSession.setActionHandler('pause', function() { /* Code excerpted. */ });
	navigator.mediaSession.setActionHandler('seekbackward', function() { /* Code excerpted. */ });
	navigator.mediaSession.setActionHandler('seekforward', function() { /* Code excerpted. */ });
	navigator.mediaSession.setActionHandler('previoustrack', function() { /* Code excerpted. */ });
	navigator.mediaSession.setActionHandler('nexttrack', function() { /* Code excerpted. */ });

	// ##########
	// GLOBAL HANDLERS
	// ##########
	const LEVELHANDLER = new LevelHandler(
		new THREE.Scene(),
		new THREE.PerspectiveCamera(0, window.innerWidth / window.innerHeight, 1, 5000)
	);
	LEVELHANDLER.SFXPlayer.playSound('startLevelSound', false);
	const WEAPONHANDLER = LEVELHANDLER.WEAPONHANDLER = new WeaponHandler(LEVELHANDLER)
	const INPUTHANDLER = new InputHandler();

	// ##########
	// WORLD SPHERE (BACKDROP COLOR)
	// ##########
	const worldSphere = new THREE.Mesh(
		new THREE.SphereGeometry(5000, 16, 8),
		new THREE.MeshBasicMaterial(
			{
				color: new THREE.Color(0xffffff),
				side: THREE.DoubleSide,
				map: LEVELHANDLER.globalTextureLoader.load("../textures/smooth.png")
			}
		)
	)
	worldSphere.material.map.wrapS = worldSphere.material.map.wrapT = THREE.RepeatWrapping;
	worldSphere.material.map.repeat.set(10, 10);
	LEVELHANDLER.scene.add(worldSphere);
	LEVELHANDLER.worldSphere = worldSphere;

	// ##########
	// RENDERER SETUP
	// ##########
	// Initializes the THREE.js renderer
	LEVELHANDLER.renderer.powerPreference = "high-performance";
	LEVELHANDLER.renderer.debug.checkShaderErrors = false;
	// LEVELHANDLER.renderer.toneMapping = THREE.ACESFilmicToneMapping // currently bugged out? (r152 see bug report from 2021 going back a few versions, im not smart enough to understand how to fix it... color math is so beyond me)
	LEVELHANDLER.renderer.outputEncoding = THREE.sRGBEncoding;
	LEVELHANDLER.renderer.outputColorSpace = THREE.SRGBColorSpace;
	LEVELHANDLER.renderer.info.autoReset = false;
	LEVELHANDLER.renderer.logarithmicDepthBuffer = true;
	LEVELHANDLER.renderer.setSize(window.innerWidth, window.innerHeight);
	LEVELHANDLER.renderer.setPixelRatio(window.devicePixelRatio);
	document.body.appendChild(LEVELHANDLER.renderer.domElement);
	LEVELHANDLER.renderer.domElement.style.zIndex = "-1";
	LEVELHANDLER.renderer.shadowMap.enabled = false
	LEVELHANDLER.renderer.setClearColor(0xffffff)
	// THREE.ColorManagement.legacyMode = false;

	// ##########
	// ENVIRONMENT LIGHTING SETUP
	// ##########
	const lightProbe = new THREE.LightProbe();
	LEVELHANDLER.scene.add(lightProbe);
	const cubeRenderTarget = new THREE.WebGLCubeRenderTarget(256);
	const cubeCamera = new THREE.CubeCamera(1, 1000, cubeRenderTarget);
	{
		// 	LEVELHANDLER.scene.add( new LightProbeHelper( lightProbe, 5 ) );
		// 	const cubemap = new THREE.CubeTextureLoader().load(
		// 		[
		// 			'../opensource/cherry_skybox/left.png',
		// 			'../opensource/cherry_skybox/right.png',
		// 			'../opensource/cherry_skybox/up.png',
		// 			'../opensource/cherry_skybox/down.png',
		// 			'../opensource/cherry_skybox/front.png',
		// 			'../opensource/cherry_skybox/back.png',
		// 		]
		// 	)
		// 	LEVELHANDLER.background = cubemap;
	}

	// ##########
	// POST PROCESSING
	// ##########
	const composer = new EffectComposer(LEVELHANDLER.renderer);
	// Ambient Occlusion
	const n8aopass = new N8AOPass(LEVELHANDLER.scene, LEVELHANDLER.camera, window.innerWidth, window.innerHeight);
	n8aopass.setQualityMode("Ultra");
	n8aopass.configuration.aoRadius = 24;
	n8aopass.configuration.distanceFalloff = 1.0;
	n8aopass.configuration.intensity = 4.5;
	n8aopass.configuration.halfRes = true;
	n8aopass.configuration.gammaCorrection = false;
	composer.addPass(n8aopass);

	// Outline
	const outlinePass = new OutlinePass(new THREE.Vector2(window.innerWidth, window.innerHeight), LEVELHANDLER.scene, LEVELHANDLER.camera);
	outlinePass.edgeStrength = 3;
	outlinePass.visibleEdgeColor.set(0xffffff);
	composer.addPass(outlinePass);
	LEVELHANDLER.outliner = outlinePass;
	LEVELHANDLER.outliner.selectedObjects = [];
	LEVELHANDLER.weaponPickups.forEach(pickup => {
		LEVELHANDLER.outliner.selectedObjects.push(pickup);
	})

	// Bloom
	const bloomPass = new UnrealBloomPass(new THREE.Vector2(8, 8), 0.8, 0, 0.45);
	composer.addPass(bloomPass);

	if (USERSETTINGS.disablePostProcessing == true) {
		n8aopass.enabled = false;
		bloomPass.enabled = false;
		const renderPass = new RenderPass(LEVELHANDLER.scene, LEVELHANDLER.camera);
		composer.addPass(renderPass);
	}

	// What the hell is this?? I fucking hate javascript.
	// Hours of research and there is no way around this awful bundling system
	// The most popular language in the world feels like its in its infancy
	// what shitholes designed this??
	// ^ note from the future: i dont remembe why i wrote this or why i was so angry. the code it references seems to be missing now.

	// ##########
	// DEFAULT AMBIENT LIGHTING
	// ##########
	const ambientLight = new THREE.AmbientLight(0xffffff, 1.25);
	LEVELHANDLER.scene.add(ambientLight);
	LEVELHANDLER.backlight = ambientLight;

	// ##########
	// DOM CONTROLS (POINTERLOCKAPI)
	// ##########
	const controls = new PointerLockControls(LEVELHANDLER);
	LEVELHANDLER.scene.add(controls.getObject());
	LEVELHANDLER.controls = controls;


	// ##########
	// FILESYSTEM CONSTANTS
	// ##########
	// These mark locations in the local file system that store the map and current weapon
	// get modelURL from URL param "mapName"
	const modelURL = new URLSearchParams(window.location.search).get("mapName");
	const weaponURL = 'nothing';
	WEAPONHANDLER.pickupWeapon(weaponURL); // same as map, but for the weapon!

	// This starts building the map ...
	// It attempts to load the JSON file, and allows quick transformations to the file (if needed / between versions) before calling buildWorldModel(), which actually builds the instanceMeshes
	// (Only one map can be loaded at once... unless?)
	// TODO - origin offsets for multiple map loading?
	//  ^ this is very unncessary but could be useful for features like streaming
	LEVELHANDLER.SFXPlayer.startMusicPlayback(LEVELHANDLER.SFXPlayer.SelectMusicID(modelURL.substring(0,2)));
	generateWorld(modelURL, LEVELHANDLER, USERSETTINGS, WEAPONHANDLER, worldSphere);

	// ##########
	// PARTICLE ENGINE INITIALIZATION
	// ##########
	const particleHandler = new ParticleMesh(voxelGeometry, voxelMaterial, USERSETTINGS.particleQualityMode * 1000, 8000);
	LEVELHANDLER.scene.add(particleHandler);
	LEVELHANDLER.particleHandler = particleHandler;
	particleHandler.frustumCulled = false;

	const clock = new THREE.Clock();
	const raycaster = new THREE.Raycaster();

	const updateDebugViz = function (delta) {
		document.querySelector("#FPSViz").textContent = Math.round(1 / delta) + " fps";
		document.querySelector("#DRAWCALLSViz").textContent = LEVELHANDLER.renderer.info.render.calls + " calls (~ " + parseInt(LEVELHANDLER.potentialCleanCalls) + " clean)";
		let numVoxels = LEVELHANDLER.numVoxels;
		numVoxels = numVoxels.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		document.querySelector("#NUMVOXELSViz").textContent = numVoxels + " voxels";
		document.querySelector("#NUMCOVERBOXESViz").textContent = LEVELHANDLER.numCoverBoxes + " IMESH Covers";
		document.querySelector("#XViz").textContent = "X: " + Math.round(LEVELHANDLER.camera.position.x);
		document.querySelector("#YViz").textContent = "Y: " + Math.round(LEVELHANDLER.camera.position.y);
		document.querySelector("#ZViz").textContent = "Z: " + Math.round(LEVELHANDLER.camera.position.z);
	}

	const playerController = new PlayerController(controls, LEVELHANDLER, USERSETTINGS, INPUTHANDLER, WEAPONHANDLER, raycaster);
	
	startChatScan(LEVELHANDLER);

	let frameCounter = 0;
	// ### RENDER LOOP ###
	const frustum = new THREE.Frustum();
	const render = function() {
		composer.render();
	}

	const update = function () {
		// Frame Calculations
		frameCounter = (frameCounter + 1) % 60;
		const delta = clock.getDelta() * LEVELHANDLER.timeModifier;
		// Debug Visualizer
		updateDebugViz(delta);
		// Player Movement Handling
		if (LEVELHANDLER.levelFinishedLoading) playerController.update(delta);
		// Update UI
		document.querySelector("#interaction-text").style.opacity -= delta * 5;
		if (LEVELHANDLER.playerHealth > 0) document.querySelector("#dead-overlay").style.opacity = 1 - (LEVELHANDLER.playerHealth / 100);/* clamp(document.querySelector("#dead-overlay").style.opacity - (delta), 0, 1);*/
		// Update Active NPC's
		LEVELHANDLER.NPCBank.forEach(npc => npc.update(delta));
		document.querySelector("#enemy-counter").textContent = LEVELHANDLER.totalNPCs;
		checkChat(LEVELHANDLER.levelID, LEVELHANDLER.camera.position);
		if (INPUTHANDLER.isKeyPressed('f')) {
			incrementChatIndex();
		}
		if (INPUTHANDLER.isKeyPressed('t')) document.querySelector("#vizbox").style.display = "block";
		else document.querySelector("#vizbox").style.display = "none";
		// Update Active Particles
		particleHandler.update(delta);
		LEVELHANDLER.killBlobs.forEach(blob => blob.move(delta));
		// Update Skybox Attributes
		worldSphere.position.copy(LEVELHANDLER.camera.position);
		worldSphere.material.map.center.set(worldSphere.material.map.center.x + (delta / 100), worldSphere.material.map.center.y + (delta / 1000));
		// Check Level Completion
		if (LEVELHANDLER.isLevelComplete == true || INPUTHANDLER.isKeyPressed('y')) {
			if (INPUTHANDLER.isKeyPressed(' ') || INPUTHANDLER.isKeyPressed('y')) {
				LEVELHANDLER.SFXPlayer.playSound("endLevelSound", false);
				LEVELHANDLER.isCameraShaking = true;
				setTimeout(() => {LEVELHANDLER.isCameraShaking = false}, 150);
				USERSETTINGS.screenShakeIntensity /= 0.25;
				LEVELHANDLER.isLevelComplete = false;
				document.querySelector("#cover-flash").style.animation = "expand 0.75s";
				document.querySelector("#end-screen").style.display = document.querySelector("#ui-overlay").style.display = "none";
				setTimeout(() => {
					let target = "index.html?mapName=" + LEVELHANDLER.nextLevelURL;
					if (LEVELHANDLER.nextLevelURL.substring(0, 3) == "../") target = LEVELHANDLER.nextLevelURL;
					if (LEVELHANDLER.nextLevelURL == "phone_call") target = "phone_call.html";
					window.location.href = target;
				}, 500);
				LEVELHANDLER.renderer.domElement.style.animation = "shrink 0.75s ease-in-out forwards";
			}
		}
		// Update Lights
		// LEVELHANDLER.levelLights.forEach(light => {
		// 	if (light.intensity > 0) light.intensity -= delta * 200;
		// 	else light.intensity = light.baseIntensity;
		// });
		// Camera Shake
		if (LEVELHANDLER.isCameraShaking) LEVELHANDLER.renderer.domElement.style.transform = "translate(" + (Math.random() * USERSETTINGS.screenShakeIntensity - USERSETTINGS.screenShakeIntensity / 2) + "px, " + (Math.random() * USERSETTINGS.screenShakeIntensity - USERSETTINGS.screenShakeIntensity / 2) + "px)";
		else LEVELHANDLER.renderer.domElement.style.transform = "translate(0px, 0px)";
		// Impact Effect Softening
		if (WEAPONHANDLER.fireSprite) {
			WEAPONHANDLER.fireSprite.material.opacity -= 7.5 * delta;
			WEAPONHANDLER.muzzleFire.material.opacity -= 15 * delta;
		}
		if (WEAPONHANDLER.weaponIsEquipped && WEAPONHANDLER.weaponRemainingAmmo == 0) {
			setInteractionText("<b>[Q]</b> THROW WEAPON");
		}

		// #########
		// DEBUG KEYS
		// #########
		// if (INPUTHANDLER.isKeyPressed("e")) {
		// 	LEVELHANDLER.playerHeight += 0.5;
		// }
		// if (INPUTHANDLER.isKeyPressed("q")) {
		// 	LEVELHANDLER.playerHeight -= 0.5;
		// }
		// DEBUG PANEL (in console)
		if (INPUTHANDLER.isKeyPressed("p")) {
			console.log("\n+==============================+\n")
			console.log("CAMERA POSITION");
			console.log(LEVELHANDLER.camera.position);
			console.log("draw calls #");
			console.log(LEVELHANDLER.renderer.info.render.calls);
			console.log("THREE SCENE");
			console.log(LEVELHANDLER.scene);
			console.log("\n+==============================+\n")
		}

		// Use arrow keys to move the WEAPONHANDLER.weaponPosition
		if (INPUTHANDLER.isKeyPressed("ArrowUp")) {
			WEAPONHANDLER.weaponPosition.y += 10;
		}
		if (INPUTHANDLER.isKeyPressed("ArrowDown")) {
			WEAPONHANDLER.weaponPosition.y -= 10;
		}
		if (INPUTHANDLER.isKeyPressed("ArrowLeft")) {
			WEAPONHANDLER.weaponPosition.x -= 10;
		}
		if (INPUTHANDLER.isKeyPressed("ArrowRight")) {
			WEAPONHANDLER.weaponPosition.x += 10;
		}

		frustum.setFromProjectionMatrix(new THREE.Matrix4().multiplyMatrices(LEVELHANDLER.camera.projectionMatrix, LEVELHANDLER.camera.matrixWorldInverse));
		instancedModelIndex.forEach(model => {
			// model.visible = true;

			if (frustum.intersectsBox(model.frustumBox)) {
				if (!model.isCovered) {
					model.visible = true;
				}
			}
			else {
				model.visible = false;
			}
		});

		requestAnimationFrame(update);
		LEVELHANDLER.renderer.info.reset();
		render();
	}

	const startGame = function() {
		if (gameStarted) return;
		document.querySelector("#da-big-text").innerHTML = "LOADING . . .";
		controls.lock();
		render();
		
		// INTRO LEVEL video
		if (LEVELHANDLER.levelID == "00") {
            const vidEl =`
            <video id="ttywd" style="background: black;position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 99999; width: 105%; height: 105%;">
                <source src="../videos/ttywd.mp4" type="video/mp4">
            </video>`;
            document.querySelector("body").insertAdjacentHTML('beforeend', vidEl);
            document.querySelector("#ttywd").play();
            setTimeout(() => {
                document.querySelector("video").remove();
            }, 3000);
        }
	
		document.querySelector("#da-big-text").style.display = "none";
		document.querySelector("#prevent-overlay").style.display = "none";
		document.querySelectorAll(".health").forEach(e => e.style.visibility = "visible");
		document.querySelector("#middle-crosshair").style.visibility = "visible";
		document.querySelector("#interaction-text").style.visibility = "visible";
		update();
	}

	let gameStarted = false;
	const n = () => {
		if (LEVELHANDLER.levelFinishedLoading == false) return;
		controls.lock();
		if (!gameStarted) {
			startGame();
			gameStarted = true;
		}
	};

	document.body.addEventListener('click', n);



	// window resize handler
	window.addEventListener('resize', () => {
		const width = window.innerWidth;
		const height = window.innerHeight;
		console.log("Handling resize ->", width, height)
		LEVELHANDLER.renderer.setSize(width, height);
		composer.setSize(width, height);
		LEVELHANDLER.camera.aspect = width / height;
		LEVELHANDLER.camera.updateProjectionMatrix();
	}, false);

	setHelpText("");
</script>

</html>